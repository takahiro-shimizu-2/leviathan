# システム要件（現段階の実装を反映）

- バージョン: 0.3.0
- 最終更新: 2025-10-08
- 目的: 自然文インテントから、MVPの薄い縦切り成果物（仕様書/デモ）を自動生成し、簡易検証・ログ化する。

## 1. ゴールと成果物
- ゴール: 入力要件に基づき最小の価値ある成果物を自動出力する。
- 主成果物（`runs/{run_id}/` 配下）:
  - `SPEC.md`: 仕様書（目的/非目標/機能一覧/ユースケース/画面要件/API 仕様/データモデル/受入条件）
  - `demo/index.html` + `style.css` + `app.js`: 簡易モックUI（検索/追加の最小動作）
  - `intent.yml` / `agent.yml`: 実行時に使用した定義のスナップショット
  - `plan.json`: Planning Orchestrator が作成する実行計画のスナップショット
  - `validation.json`: Validation Orchestrator の自動検証結果
  - `logs.txt`: 実行ログ（rc/timeout/stdout/stderr を試行ごとに追記）
  - `langstack.txt`: LangGraph系ワークフローの進行ログ（実験機能）
  - `artifacts/`: 設計/API/テスト等の補助成果（LangGraph・CrewAI利用時）

## 2. 実行インターフェース
- CLI（PoC・既定）: `python -m agi_poc.cli run "<要件>" [--dry-run] [--timeout N] [--budget N] [--yes] [--strategy simple|ranked|cascade]`
  - `--strategy`: `simple`=単一選定, `ranked`=上位1, `cascade`=候補順に失敗時切替
  - 返却: 実行結果と `Run ID`
- CLI（互換ランナー）: `python bin/agi run "<要件>" [--dry-run] [--no-agent-gen]`
  - `create_spec_document` では `--style detailed` を付与して詳細仕様を生成
  - 低信頼/デモ語を含む場合は `create_demo_app` を優先
- LangGraph ランナー（実験）: `python src/agi_poc/langgraph_runner.py <prompt> [--simulate] [--checkpoint] [--resume RUN_ID]`
  - CrewAI/LangChain連携を試行しつつ、未解決時はPoC実装にフォールバック
- LangStackオーケストレーション（PoCアダプタ）: `python bin/langstack run --input "<要件>" [--simulate] [--yes]`
  - `registry/manifest_langstack.yaml` を読み取り、現在のPoC機能でノード進行を模擬/実行
  - `--simulate` で各ノードを疑似実行（`langstack.txt` のみ生成）／`--yes` で承認スキップ
- Web UI: `python bin/agi_web`（http://127.0.0.1:8000）
  - 入力送信（/run）、進捗/状態ポーリング（/status）、成果物閲覧（/view, /static）、添付アップロード（/upload）
  - Devダッシュボード同時起動: `python bin/run_local --open`（UIとダッシュボードを併起）

## 3. インテント検出と選択
- 検出（`src/agi_poc/intent.py`）:
  - デモ系語（例: "デモ", "モック", "UI", "試作" 等）→ `create_demo_app`
  - 仕様系語（例: "仕様", "要件", "設計", "spec" 等）→ `create_spec_document`
  - その他 → `generic_task`
- 互換ランナーの補正（`bin/agi`）:
  - デモ語 or 低スコア（<0.15）時は `create_demo_app` を優先選択

## 4. YAML レジストリとテンプレ生成
- 検索/生成（`yaml_registry.find_or_generate`）:
  - `intents/{intent_id}.yml`/`.yaml` を探索。未存在なら `templates/yaml/basic.yml` から最小テンプレ生成
- 正規化（`schemas.normalize_task_yaml`）:
  - `constraints.max_time_sec` → `timeout_s`（無指定は60）
  - `safety` 未指定時に `{allowed_ops: []}` を補完
  - `outputs` 未指定時に `runs/{run_id}/output.txt` を補完
  - `id` → `intent_id` に転写（存在時）
- スキーマ検証（`schemas.validate_task_yaml`）: `intent_id`/`inputs[]`/`outputs[]`/`timeout_s:int`/`safety:dict` を必須確認

## 5. エージェント選定/自動生成
- 候補列挙（`agent_registry.list_candidates`）:
  - `agents/*/agent.yml` を走査し `capabilities` と `__intent_id__:<id>` 近接でスコアリング
- 選定/生成（`agent_registry.select_or_generate`）:
  - 要求capabilitiesを満たす既存を優先、なければ `templates/agents/basic.yml` から `agents/auto_{intent}/agent.yml` を生成
- 正規化/検証（`schemas.normalize_agent_yaml` / `validate_agent_yaml`）:
  - 既定 `model=gpt-4o-mini`, `temperature=0.2`, `allow_* = false` 補完
- エージェント実行エントリ:
  - `entry.type=cli` の場合 `bin/<command>` を呼び出し。引数の `{yaml}/{input}/{run_id}` を解決
  - 未指定時は `bin/agent_cli` を既定使用

## 6. 実行・再試行とログ
- 実行準備（`runner.prepare_run_dir`）: `runs/{timestamp_uuid}/` を作成
- 実行（`runner.run_agent`）: タイムアウト（`min(CLI指定, intent.timeout_s)`）付きでサブプロセス実行
- 再試行（`execute_with_retry`）: 指定回数（PoCは1リトライ）で rc=0 まで試行
- ログ（`runs/{run_id}/logs.txt`）: 試行ごとに `attempt/rc/timeout/stdout/stderr` を追記
- 仕様/エージェントの写し（`intent.yml`/`agent.yml`）を `runs/{run_id}/` に保存

## 7. 成功判定（`runner.evaluate_success`）
- デモ出力（`demo/index.html`）の場合:
  - 同ディレクトリに `style.css` と `app.js` が存在し、`index.html` に `id="app"` を含む
- 仕様出力（`SPEC.md`）の場合（全て満たすとOK）:
  - 必須セクションが存在: 目的/非目標/機能一覧/ユースケース/画面要件/API 仕様/データモデル/受入条件
  - API表に `Method`/`Path` 列がある
  - データモデル: エンティティ行が3件以上、属性テーブル（`| 属性 |`）が存在
  - ユースケース: `### UC-` の見出しが3件以上、かつ 基本フロー/代替フロー/例外 を含む
  - 受入条件: 箇条書きが3件以上

## 8. 承認ゲート（`approval.py`）
- 自動判定で承認要否を決定（`--yes` でスキップ可）
  - `task.safety.allowed_ops` に `write`/`network` が含まれる、または `agent.allow_*` が真 → 承認を要求
  - `--dry-run` 時は承認不要

## 9. サポートするインテント定義（現状）
- `intents/create_spec_document.yml`（仕様生成）
  - 成功基準は上記 7. の仕様出力要件と一致
- `intents/create_demo_app.yml`（簡易デモ生成）
  - 成功基準は上記 デモ出力要件と一致
- `intents/generic_task.yml`（汎用: 出力テキストのみ）

## 10. 主要エージェント/CLI の実態
- `bin/agent_cli`（実体生成器）:
  - `create_spec_document`: `--style detailed` 時に詳細仕様を生成
    - セクション: 目的/非目標/機能一覧(表)/ユースケース(3件)/画面要件(表)/API 仕様(表)/データモデル(エンティティ+属性表)/受入条件/メモ
  - `create_demo_app`: `index.html` `style.css` `app.js` を生成（検索/追加の最小動作を実装）
  - その他: 簡易テキスト出力
- 代表的エージェント定義:
  - `agents/spec_writer/agent.yml`: 仕様書生成（`entry: agent_cli --style detailed`）
  - `agents/auto_create_demo_app/agent.yml` / `agents/auto_generic_task/agent.yml`: 自動生成系のフォールバック
  - `agents/*_orchestrator/`: intent/planning/execution/validation の各オーケストレータ定義（CLI連携）

## 11. LangGraph × CrewAI × LangChain（実験）
- マニフェスト: `registry/manifest_langstack.yaml`
  - ノード: intent → clarify → yaml_autogen → planning → execution → validation → review → deploy
  - CrewAI 役割例: architect/tech_lead/coder_frontend/coder_backend/tester/devops
  - 成果物スキーマ: design_doc/api_spec/db_schema/test_reports/pr_link/deploy_info など
- 実装: `src/agi_poc/langgraph_runner.py`
  - `--simulate`: 生成物をモック
  - `--checkpoint --resume`: SQLite チェックポイントで再開
  - CrewAI/LLMが未設定/未導入の環境では PoC 実装（agent_cli 相当）でフォールバック実行

## 17. オーケストレーションとオーケストレーター（現状仕様）
- 実装形態（2系統）:
  - PoCアダプタ（既定）: `bin/langstack` → `src/agi_poc/langstack_runner.py` が `manifest_langstack.yaml` を読み、手元のPoC機能群でワークフローを段階実行/模擬。
  - 実験ランナー: `src/agi_poc/langgraph_runner.py` が LangGraph/CrewAI/LangChain を用いた本設計の流れを試行（依存が無い場合はPoCにフォールバック）。

- ノードと役割（代表・現状）:
  - `supreme_orchestrator`（監督）: ルーティング判定。入力不足→`user_clarify`、未検出→`intent_orchestrator`、未計画→`planning_orchestrator`、準備完了→`execution_orchestrator`。
  - `intent_orchestrator`（CLI: `intent_orchestrator_cli`）:
    - 入力から `intent_id` 検出、`intents/{intent}.yml` を探索/自動生成、正規化・検証。
    - `runs/{run_id}/intent.yml` を保存。標準出力で `intent_id` とパスを返却。
  - `yaml_autogen`（CLI: `yaml_autogen_cli`）:
    - Intent/Agent YAML の不足をテンプレから合成生成し、`intent.yml`/`agent.yml` を保存。
  - `planning_orchestrator`（CLI: `planning_orchestrator_cli`）:
    - 要求capabilitiesに基づきエージェントを選定/生成し、実行計画を作成。
    - `runs/{run_id}/agent.yml` と `plan.json` を保存（`persist_specs` により intent/agent の写しも保存）。
  - `execution_orchestrator`（CLI: `execution_orchestrator_cli`）:
    - `intent.yml`/`agent.yml` を読み、`execute_with_retry` で実行。主要成果物のパスを標準出力。
  - `validation_orchestrator`（CLI: `validation_orchestrator_cli`）:
    - `evaluate_success` により自動検証し、`validation.json` を保存。`approved` の可否を返却。

- PoCアダプタにおける現在のフロー（簡略）:
  - 進行: `supreme -> (clarify) -> intent -> (yaml_autogen) -> planning -> execution -> validation -> review -> deploy -> end`
  - 実行モード:
    - `--simulate`: すべて疑似実行。`runs/{run_id}/langstack.txt` にイベントを追記。
    - 実実行: `create_spec_document` を代表タスクとして実行し、成功評価→承認→レビュー→デプロイを順に記録。
  - 失敗時の挙動（現状PoC内のみ）:
    - `execution` 段での評価NG時、レジストリから収集した候補エージェントに順次切替（カスケード）し再実行。成功時に先へ、全滅で打ち切り。

- マニフェストとの対応:
  - 参照ファイル: `registry/manifest_langstack.yaml`
  - `workflow.nodes` でノード列と `conditional_edges/next` を定義。PoCアダプタは主要ノードを模擬し、未実装ノードはスキップ/簡易代替。
  - `crews/agents/tools` 等は実験ランナー側で利用（PoCアダプタは読み取りのみで実行はしない）。

- 生成物/ログ（補足）:
  - `runs/{run_id}/plan.json`: intent, 選定エージェント, タイムアウト, 出力要件を記録。
  - `runs/{run_id}/validation.json`: 自動検証の詳細（チェック名/可否/メモ）。
  - `runs/{run_id}/langstack.txt`: ノード遷移/実行エージェント/評価結果/承認・レビュー・デプロイの記録。

## 12. Web UI と Dev ダッシュボード
- Web UI（`bin/agi_web`）:
  - エンドポイント: `/`（入力UI）, `/run`（実行）, `/status`（進捗JSON）, `/upload`（添付）, `/view`（埋込ビュー）, `/static`（静的返却）, `/dev`（開発者ビュー）, `/dev_stats`（メトリクス）, `/resume`（チェックポイント再開）, `/shutdown`, `/health`
  - アップロード: `uploads/` もしくは `runs/{run_id}/inputs/` に保存（先行run指定時）
  - ビュー: テキストはプレーン/iframe、バイナリは `/static` リンクを提供
- Dev ダッシュボード（`bin/dev_dashboard.py`）:
  - 最近のRuns可視化、簡易メトリクス（失敗率/総コスト）集計、リンク提供
  - `DEV_DASHBOARD_TOKEN` による簡易保護（任意）

## 13. セキュリティ/制約
- 既定でネットワーク/書込は許可しない（Agent YAML: `allow_network=false`, `allow_write=false`）
- 承認ゲートで危険操作をブロック可能
- Web UI の `/view`/`/static` はリポジトリ以下の相対パスのみ許容（パストラバーサル対策）
- `.env` を `bin/langstack` が読み込み（APIキー等）。存在しなくても動作

## 14. ディレクトリ構成（抜粋）
```
intents/                 # インテント定義（.yml/.yaml）
agents/                  # エージェント定義と実装（一部）
registry/                # LangGraph/CrewAI/ツールのマニフェスト
templates/               # 生成テンプレ（intent/agent/blueprint）
runs/<run_id>/           # 実行ごとの成果物/ログ/メタ
uploads/                 # Web UI からのアップロード保管先
bin/                     # CLI群（agi / agent_cli / langstack / agi_web 等）
src/agi_poc/             # PoC実装（CLI/レジストリ/実行/承認/評価）
```

## 15. Intent YAML スキーマ要件（要約）
- 必須: `intent_id`, `inputs[]`, `outputs[]({path})`, `timeout_s:int`, `safety: {allowed_ops: []}`
- 任意: `version`, `description`, `steps`, `success_criteria[]`, `agent_requirements[]`, `constraints`
- 正規化: `constraints.max_time_sec` の転写、`safety/outputs` の補完、`id→intent_id`

## 16. 既知の制限・注意
- LangGraph/CrewAI 統合は実験段階。依存が無い環境では PoC 経路に自動フォールバック
- `bin/agi` と `src/agi_poc/cli.py` は類似だが、インテント優先ロジックや評価条件に差異あり
- `src/intents/` にも定義があるが、ランナーは基本 `intents/`（ルート）を参照
